# 救護車庫存查詢系統 - 架構文檔

## 📋 系統概述

本系統是一個基於自然語言的資料庫查詢系統，允許使用者用中文問問題，系統會自動生成 SQL 並執行查詢。

### 技術棧
- **語言**: Python 3
- **資料庫**: PostgreSQL 15+
- **LLM**: Ollama (qwen3:30b)
- **容器化**: Docker + Docker Compose
- **依賴**: psycopg2-binary, requests

---

## 🏗️ 當前架構

### 單體式設計
目前所有功能都在 `test_llm_query_ollama.py` 中（454 行）：

```
test_llm_query_ollama.py
├── 配置設定 (L18-29)
├── 資料庫 Schema 定義 (L35-59)
├── 輔助函數 (L65-69)
├── Ollama API 調用 (L75-105)
├── 主查詢邏輯 (L111-221)
├── 查詢介面 (L227-245)
├── 互動模式 (L251-287)
├── Demo 模式 (L292-334)
├── 系統檢查 (L340-405)
└── 主程式入口 (L411-453)
```

### 資料流
```
使用者問題
    ↓
生成 SQL (Ollama)
    ↓
清理 SQL
    ↓
執行查詢 (PostgreSQL)
    ↓
格式化結果
    ↓
生成回應 (Ollama)
    ↓
顯示給使用者
```

---

## 🎯 當前問題

### 1. **程式碼組織**
- ❌ 所有功能混在一個檔案
- ❌ 職責不清晰
- ❌ 難以測試
- ❌ 難以維護

### 2. **錯誤處理**
- ❌ 部分函數缺少異常處理
- ❌ 錯誤訊息不一致
- ❌ 沒有 logging 機制

### 3. **安全性**
- ⚠️ SQL 注入風險（雖然 LLM 生成，但仍需驗證）
- ⚠️ 資料庫密碼明文存在環境變數
- ⚠️ 沒有輸入驗證

### 4. **可維護性**
- ❌ 沒有類型提示
- ❌ 魔術數字和硬編碼字串
- ❌ 配置散落各處

### 5. **可測試性**
- ❌ 沒有單元測試
- ❌ 函數耦合度高
- ❌ 難以 mock 外部依賴

---

## 🚀 改進後的架構

### 模組化設計
```
ambulance_inventory/
├── config.py              # 配置管理
├── database.py            # 資料庫操作
├── ollama_client.py       # Ollama API 封裝
├── query_engine.py        # 查詢邏輯
├── ui/
│   ├── __init__.py
│   ├── interactive.py     # 互動模式
│   ├── demo.py           # Demo 模式
│   └── checker.py        # 系統檢查
├── utils/
│   ├── __init__.py
│   ├── logger.py         # 日誌工具
│   └── validators.py     # 輸入驗證
└── main.py               # 主程式入口
```

### 優勢
✅ **單一職責**: 每個模組負責一個功能
✅ **易於測試**: 可獨立測試每個模組
✅ **易於擴展**: 新增功能不影響現有代碼
✅ **易於維護**: 清晰的代碼結構
✅ **類型安全**: 完整的類型提示

---

## 🔧 核心模組說明

### 1. **config.py** - 配置管理
```python
- 集中管理所有配置
- 環境變數讀取
- 配置驗證
- Schema 定義
```

### 2. **database.py** - 資料庫操作
```python
- 連接池管理
- 查詢執行
- 結果格式化
- 異常處理
```

### 3. **ollama_client.py** - Ollama 客戶端
```python
- API 調用封裝
- 重試機制
- 錯誤處理
- 連接管理
```

### 4. **query_engine.py** - 查詢引擎
```python
- SQL 生成
- SQL 清理和驗證
- 結果處理
- 回應生成
```

### 5. **ui/** - 使用者介面
```python
interactive.py  # 互動模式實現
demo.py        # Demo 模式實現
checker.py     # 系統狀態檢查
```

### 6. **utils/** - 工具函數
```python
logger.py      # 統一的日誌系統
validators.py  # 輸入驗證工具
```

---

## 📈 改進計劃

### Phase 1: 基礎重構 ✅
- [x] 創建模組結構
- [ ] 拆分功能到各模組
- [ ] 添加類型提示
- [ ] 改進錯誤處理

### Phase 2: 增強功能
- [ ] 添加日誌系統
- [ ] 實現配置驗證
- [ ] 添加輸入驗證
- [ ] SQL 注入防護

### Phase 3: 測試與文檔
- [ ] 單元測試
- [ ] 集成測試
- [ ] API 文檔
- [ ] 使用手冊

---

## 🔍 關鍵設計決策

### 1. **為什麼選擇模組化？**
- 符合單一職責原則
- 提高代碼可重用性
- 便於團隊協作
- 易於單元測試

### 2. **為什麼使用類型提示？**
- IDE 自動補全
- 早期發現錯誤
- 代碼自我文檔化
- 提高可讀性

### 3. **為什麼需要 Logger？**
- 追蹤問題
- 性能分析
- 審計記錄
- 生產環境監控

### 4. **為什麼驗證 SQL？**
- 防止意外的危險操作
- 提高查詢成功率
- 安全性考量
- 用戶體驗優化

---

## 🎯 性能考量

### 資料庫連接
- 使用連接池避免重複建立連接
- 適當的超時設置
- 自動重連機制

### Ollama 調用
- 首次載入模型需時間（5-10秒）
- 溫度參數影響生成質量
- Context 長度影響性能

### 記憶體使用
- qwen3:30b 約需 16-18GB VRAM
- 結果集限制避免 OOM
- 適當清理臨時變數

---

## 📝 模型資訊

### qwen3:30b
- **參數量**: 30B
- **VRAM 需求**: 16-18GB
- **推理速度**: RTX 5070 約 3-8 秒/查詢
- **準確率**: SQL 生成約 85-90%
- **優勢**: 更新的架構，更好的中文支援

---

## 🔐 安全考量

### 當前實現
- ✅ 資料庫密碼通過環境變數
- ✅ 使用 RealDictCursor 避免 SQL 注入（查詢階段）
- ⚠️ LLM 生成的 SQL 未經驗證
- ⚠️ 沒有用戶權限控制

### 改進建議
- 添加 SQL 白名單驗證
- 實現查詢日誌
- 限制危險操作（DROP, DELETE 等）
- 實現查詢頻率限制

---

## 📊 未來擴展可能

### 功能擴展
- Web API (FastAPI/Flask)
- 前端介面 (React/Vue)
- 多資料庫支援
- 查詢結果匯出 (CSV/Excel)
- 資料視覺化
- 語音輸入

### 技術擴展
- 非同步處理 (asyncio)
- 快取機制 (Redis)
- 分散式部署
- 監控告警系統

---

*文檔版本: 1.0*
*更新日期: 2026-01-14*
*模型版本: qwen3:30b*
