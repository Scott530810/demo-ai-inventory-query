<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGC AI åº«å­˜æŸ¥è©¢ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.ok { background: #4ade80; }
        .status-dot.fail { background: #f87171; }
        .status-dot.loading { background: #fbbf24; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .query-section {
            padding: 25px;
            border-bottom: 1px solid #eee;
        }

        .query-section h2 {
            color: #4c1d95;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        #queryInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #queryInput:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .demo-section {
            padding: 20px 25px;
            background: #f9fafb;
            border-bottom: 1px solid #eee;
        }

        .demo-section h3 {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .demo-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .demo-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .demo-btn:hover {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .result-section {
            padding: 25px;
            min-height: 200px;
        }

        .result-section h2 {
            color: #4c1d95;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        #result {
            color: #374151;
        }

        .result-placeholder {
            color: #9ca3af;
            text-align: center;
            padding: 40px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sql-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .answer-box {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 20px;
            border-radius: 0 10px 10px 0;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .error-box {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 20px;
            border-radius: 0 10px 10px 0;
            color: #dc2626;
        }

        /* Output mode tabs */
        .output-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .output-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .output-tab:hover {
            color: #4c1d95;
        }

        .output-tab.active {
            color: #4c1d95;
            border-bottom-color: #8b5cf6;
            font-weight: bold;
        }

        .output-content {
            display: none;
        }

        .output-content.active {
            display: block;
        }

        .table-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.4;
        }

        /* HTML è¡¨æ ¼æ¨£å¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
        }

        .result-table th {
            background: #4c1d95;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .result-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .result-table tbody tr:hover {
            background: #f5f3ff;
        }

        .result-table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .result-table tbody tr:nth-child(even):hover {
            background: #f5f3ff;
        }

        .table-info {
            margin-top: 10px;
            color: #6b7280;
            font-size: 13px;
        }

        .html-table-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            overflow-x: auto;
        }

        .result-count {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .timing-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #475569;
        }

        .timing-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .timing-item strong {
            color: #0369a1;
        }

        .timing-total {
            margin-left: auto;
            padding-left: 12px;
            border-left: 1px solid #94a3b8;
        }

        .timing-total strong {
            color: #059669;
            font-size: 14px;
        }

        /* Output mode toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #22c55e;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #8b5cf6;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .mode-label {
            font-size: 14px;
            color: #4b5563;
        }

        .mode-label.active {
            font-weight: bold;
            color: #4c1d95;
        }

        /* RAG mode selector */
        .rag-mode-selector {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .rag-mode-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rag-mode-btn:hover {
            border-color: #8b5cf6;
        }

        .rag-mode-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border-color: #8b5cf6;
        }

        .rag-mode-btn .icon {
            font-size: 14px;
        }

        /* RAG context display */
        .rag-context-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin-top: 15px;
        }

        .rag-context-header {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rag-source-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #fcd34d;
        }

        .rag-source-item:last-child {
            margin-bottom: 0;
        }

        .rag-source-meta {
            font-size: 12px;
            color: #92400e;
            margin-bottom: 6px;
            display: flex;
            gap: 15px;
        }

        .rag-source-content {
            font-size: 13px;
            color: #374151;
            line-height: 1.6;
            max-height: 100px;
            overflow-y: auto;
        }

        .rag-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .config-section {
            padding: 15px 25px;
            background: #f9fafb;
            border-top: 1px solid #eee;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .config-input {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .config-input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        label {
            font-size: 14px;
            color: #6b7280;
        }

        /* Model selector styles */
        .model-selector {
            position: relative;
            display: inline-block;
        }

        .model-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .model-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 280px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            margin-top: 8px;
            overflow: hidden;
        }

        .model-dropdown.show {
            display: block;
        }

        .model-dropdown-header {
            padding: 12px 15px;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            font-weight: bold;
            color: #374151;
        }

        .model-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .model-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }

        .model-item:hover {
            background: #f9fafb;
        }

        .model-item.active {
            background: #ede9fe;
            color: #7c3aed;
        }

        .model-item.active::after {
            content: 'âœ“';
            color: #22c55e;
            font-weight: bold;
        }

        .model-item.loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .model-loading {
            padding: 20px;
            text-align: center;
            color: #6b7280;
        }

        .model-label {
            font-size: 11px;
            color: #6b7280;
            margin-left: 8px;
            white-space: nowrap;
        }

        .model-item.active .model-label {
            color: #7c3aed;
        }

        .server-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .server-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .server-btn.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        footer {
            text-align: center;
            color: rgba(255,255,255,0.7);
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AGC AI åº«å­˜æŸ¥è©¢ç³»çµ±</h1>
            <p>ä½¿ç”¨è‡ªç„¶èªè¨€æŸ¥è©¢è¨­å‚™åº«å­˜è³‡è¨Š</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="dbStatus"></span>
                <span>è³‡æ–™åº«</span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="ollamaStatus"></span>
                <span>Ollama</span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="ragStatus"></span>
                <span>RAG <small id="ragChunks"></small></span>
            </div>
            <div class="status-item model-selector">
                <span>æ¨¡å‹: <strong id="modelName">-</strong></span>
                <button class="model-btn" onclick="toggleModelDropdown(event)">âš™ï¸ åˆ‡æ›</button>
                <div class="model-dropdown" id="modelDropdown">
                    <div class="model-dropdown-header">é¸æ“‡æ¨¡å‹</div>
                    <div class="model-list" id="modelList">
                        <div class="model-loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>
            <button class="btn" style="padding: 8px 15px; font-size: 14px;" onclick="checkHealth()">
                ğŸ”„ é‡æ–°æª¢æŸ¥
            </button>
        </div>

        <div class="card">
            <div class="query-section">
                <h2>ğŸ’¬ è¼¸å…¥æ‚¨çš„å•é¡Œ</h2>
                <div class="input-group">
                    <input type="text" id="queryInput" placeholder="ä¾‹å¦‚ï¼šAEDé™¤é¡«å™¨æœ‰åº«å­˜å—ï¼Ÿ"
                           onkeypress="if(event.key==='Enter') sendQuery()">
                    <button class="btn btn-primary" id="sendBtn" onclick="sendQuery()">
                        ğŸ” æŸ¥è©¢
                    </button>
                </div>
                <div class="mode-toggle" style="margin-top: 15px;">
                    <span class="mode-label" id="modeFastLabel">âš¡ å¿«é€Ÿæ¨¡å¼</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="useLlmToggle" checked onchange="updateModeLabel()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="mode-label active" id="modeLlmLabel">ğŸ¤– LLM å›ç­”</span>
                    <span style="color: #9ca3af; font-size: 12px; margin-left: 10px;">
                        (å¿«é€Ÿæ¨¡å¼åªç”ŸæˆSQLï¼Œä¸ç”¨LLMç”Ÿæˆå›ç­”)
                    </span>
                </div>
                <div style="margin-top: 12px;">
                    <label style="font-size: 13px; color: #6b7280; margin-right: 10px;">ğŸ“š è³‡æ–™ä¾†æº:</label>
                    <div class="rag-mode-selector" style="display: inline-flex;">
                        <button class="rag-mode-btn active" data-mode="sql_only" onclick="setRagMode('sql_only')">
                            <span class="icon">ğŸ—„ï¸</span> åƒ…åº«å­˜
                        </button>
                        <button class="rag-mode-btn" data-mode="hybrid" onclick="setRagMode('hybrid')">
                            <span class="icon">ğŸ”€</span> æ··åˆæ¨¡å¼
                        </button>
                        <button class="rag-mode-btn" data-mode="rag_only" onclick="setRagMode('rag_only')">
                            <span class="icon">ğŸ“–</span> åƒ…å‹éŒ„
                        </button>
                    </div>
                    <span style="color: #9ca3af; font-size: 12px; margin-left: 10px;" id="ragModeHint">
                        (æŸ¥è©¢åº«å­˜è³‡æ–™åº«)
                    </span>
                </div>
            </div>

            <div class="demo-section">
                <h3>ğŸ“š ç¤ºç¯„æŸ¥è©¢ (é»æ“Šç›´æ¥åŸ·è¡Œ)</h3>
                <div class="demo-buttons">
                    <button class="demo-btn" onclick="runDemo('è«‹åˆ—å‡ºæ‰€æœ‰æœ‰åº«å­˜çš„AEDé™¤é¡«å™¨ï¼ŒåŒ…å«å“ç‰Œã€å‹è™Ÿå’Œåº«å­˜æ•¸é‡')">AEDé™¤é¡«å™¨åº«å­˜</button>
                    <button class="demo-btn" onclick="runDemo('è«‹åˆ—å‡ºæ‰€æœ‰æ“”æ¶è¨­å‚™çš„å“ç‰Œã€å‹è™Ÿå’Œåº«å­˜æ•¸é‡')">æ“”æ¶è¨­å‚™æ¸…å–®</button>
                    <button class="demo-btn" onclick="runDemo('è«‹åˆ—å‡ºå–®åƒ¹ä½æ–¼50000å…ƒçš„ç›£è¦–å™¨ï¼ŒåŒ…å«å“ç‰Œã€å‹è™Ÿå’Œåƒ¹æ ¼')">ç›£è¦–å™¨(5è¬å…§)</button>
                    <button class="demo-btn" onclick="runDemo('è«‹åˆ—å‡ºåº«å­˜æ•¸é‡ä½æ–¼10ä»¶çš„å•†å“ï¼ŒåŒ…å«ç”¢å“åç¨±ã€åˆ†é¡å’Œåº«å­˜æ•¸é‡')">ä½åº«å­˜å•†å“</button>
                    <button class="demo-btn" onclick="runDemo('è«‹åˆ—å‡ºæ‰€æœ‰Philipså“ç‰Œçš„ç”¢å“ï¼ŒåŒ…å«åç¨±ã€å‹è™Ÿå’Œå–®åƒ¹')">Philipsç”¢å“</button>
                </div>
                <h3 style="margin-top: 15px;">ğŸ“– å‹éŒ„æŸ¥è©¢ (éœ€åˆ‡æ›è‡³æ··åˆ/å‹éŒ„æ¨¡å¼)</h3>
                <div class="demo-buttons">
                    <button class="demo-btn" onclick="runRagDemo('ZOLL AEDçš„ä½¿ç”¨æ–¹æ³•æ˜¯ä»€éº¼ï¼Ÿ')">AEDä½¿ç”¨æ–¹æ³•</button>
                    <button class="demo-btn" onclick="runRagDemo('Fernoæ“”æ¶çš„è¦æ ¼èªªæ˜')">æ“”æ¶è¦æ ¼</button>
                    <button class="demo-btn" onclick="runRagDemo('æ°§æ°£ç“¶çš„å®‰å…¨æ³¨æ„äº‹é …')">æ°§æ°£å®‰å…¨</button>
                </div>
            </div>

            <div class="result-section">
                <h2>ğŸ“‹ æŸ¥è©¢çµæœ</h2>
                <div id="resultTabs" style="display: none;">
                    <div class="output-tabs">
                        <button class="output-tab active" onclick="switchOutputTab('llm')">ğŸ¤– LLM å›ç­”</button>
                        <button class="output-tab" onclick="switchOutputTab('table')">ğŸ“Š è¡¨æ ¼æ ¼å¼</button>
                        <button class="output-tab" onclick="switchOutputTab('rag')" id="ragTab" style="display: none;">ğŸ“š å‹éŒ„åƒè€ƒ</button>
                        <button class="output-tab" onclick="switchOutputTab('raw')">ğŸ“„ åŸå§‹è³‡æ–™</button>
                    </div>
                </div>
                <div id="result">
                    <div class="result-placeholder">
                        æŸ¥è©¢çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡<br>
                        è«‹è¼¸å…¥å•é¡Œæˆ–é»æ“Šç¤ºç¯„æŸ¥è©¢
                    </div>
                </div>
            </div>

            <div class="config-section">
                <div class="config-row">
                    <label>å¿«é€Ÿåˆ‡æ›:</label>
                    <button class="server-btn" onclick="switchServer('localhost', 8000)">ğŸ  æœ¬åœ°</button>
                    <button class="server-btn" onclick="switchServer('192.168.50.2', 8000)">ğŸ–¥ï¸ SPARK</button>
                    <span style="color: #9ca3af; margin: 0 10px;">|</span>
                    <label>è‡ªè¨‚:</label>
                    <input type="text" id="serverHost" class="config-input" value="192.168.50.2" style="width: 120px;">
                    <label>:</label>
                    <input type="number" id="serverPort" class="config-input" value="8000" style="width: 70px;">
                    <button class="btn" style="padding: 8px 15px; font-size: 14px;" onclick="saveConfig()">
                        ğŸ’¾ å„²å­˜
                    </button>
                </div>
            </div>
        </div>

        <footer>
            ç‰ˆæœ¬ 2.5.0 | AGC AI åº«å­˜æŸ¥è©¢ç³»çµ± | æ”¯æ´ LLM/å¿«é€Ÿé›™æ¨¡å¼ + RAG å‹éŒ„æœå°‹
        </footer>
    </div>

    <script>
        // Configuration
        let config = {
            host: localStorage.getItem('spark_host') || '192.168.50.2',
            port: localStorage.getItem('spark_port') || '8000'
        };

        // RAG mode state
        let currentRagMode = 'sql_only';

        function setRagMode(mode) {
            currentRagMode = mode;
            // Update button states
            document.querySelectorAll('.rag-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            // Update hint text
            const hints = {
                'sql_only': '(æŸ¥è©¢åº«å­˜è³‡æ–™åº«)',
                'hybrid': '(åŒæ™‚æŸ¥è©¢åº«å­˜+å‹éŒ„)',
                'rag_only': '(åƒ…æœå°‹å‹éŒ„æ–‡ä»¶)'
            };
            document.getElementById('ragModeHint').textContent = hints[mode] || '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('serverHost').value = config.host;
            document.getElementById('serverPort').value = config.port;
            updateServerButtons();
            checkHealth();
        });

        function getBaseUrl() {
            return `http://${config.host}:${config.port}`;
        }

        function saveConfig() {
            config.host = document.getElementById('serverHost').value;
            config.port = document.getElementById('serverPort').value;
            localStorage.setItem('spark_host', config.host);
            localStorage.setItem('spark_port', config.port);
            updateServerButtons();
            alert('è¨­å®šå·²å„²å­˜ï¼');
            checkHealth();
        }

        function switchServer(host, port) {
            config.host = host;
            config.port = port.toString();
            document.getElementById('serverHost').value = host;
            document.getElementById('serverPort').value = port;
            localStorage.setItem('spark_host', host);
            localStorage.setItem('spark_port', port.toString());
            updateServerButtons();
            checkHealth();
        }

        function updateServerButtons() {
            document.querySelectorAll('.server-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (config.host === 'localhost' && config.port === '8000') {
                document.querySelector('.server-btn:nth-child(2)')?.classList.add('active');
            } else if (config.host === '192.168.50.2' && config.port === '8000') {
                document.querySelector('.server-btn:nth-child(3)')?.classList.add('active');
            }
        }

        async function checkHealth() {
            const dbStatus = document.getElementById('dbStatus');
            const ollamaStatus = document.getElementById('ollamaStatus');
            const ragStatus = document.getElementById('ragStatus');
            const ragChunks = document.getElementById('ragChunks');
            const modelNameEl = document.getElementById('modelName');

            dbStatus.className = 'status-dot loading';
            ollamaStatus.className = 'status-dot loading';
            ragStatus.className = 'status-dot loading';
            modelNameEl.textContent = 'æª¢æŸ¥ä¸­...';
            ragChunks.textContent = '';

            try {
                const response = await fetch(`${getBaseUrl()}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();

                dbStatus.className = `status-dot ${data.database ? 'ok' : 'fail'}`;
                ollamaStatus.className = `status-dot ${data.ollama ? 'ok' : 'fail'}`;
                ragStatus.className = `status-dot ${data.rag_enabled ? 'ok' : 'fail'}`;
                ragChunks.textContent = data.rag_chunks > 0 ? `(${data.rag_chunks})` : '';

                // Update both display and internal state
                const serverModel = data.model || 'æœªçŸ¥';
                modelNameEl.textContent = serverModel;
                currentModel = serverModel;  // Sync internal state with server
            } catch (error) {
                dbStatus.className = 'status-dot fail';
                ollamaStatus.className = 'status-dot fail';
                ragStatus.className = 'status-dot fail';
                modelNameEl.textContent = 'é€£ç·šå¤±æ•—';
                ragChunks.textContent = '';
                currentModel = '';
            }
        }

        function runDemo(query) {
            document.getElementById('queryInput').value = query;
            sendQuery();
        }

        function runRagDemo(query) {
            // Switch to hybrid mode for RAG demos
            if (currentRagMode === 'sql_only') {
                setRagMode('hybrid');
            }
            document.getElementById('queryInput').value = query;
            sendQuery();
        }

        async function sendQuery() {
            const input = document.getElementById('queryInput');
            const resultDiv = document.getElementById('result');
            const tabsDiv = document.getElementById('resultTabs');
            const sendBtn = document.getElementById('sendBtn');
            const useLlm = document.getElementById('useLlmToggle').checked;
            const question = input.value.trim();

            if (!question) {
                alert('è«‹è¼¸å…¥å•é¡Œ');
                return;
            }

            // Show loading
            sendBtn.disabled = true;
            tabsDiv.style.display = 'none';
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...<br>
                    <small style="color: #9ca3af;">${useLlm ? '(LLM æ¨¡å¼ï¼Œéœ€è¼ƒé•·æ™‚é–“)' : '(å¿«é€Ÿæ¨¡å¼)'}</small>
                    </p>
                </div>
            `;

            try {
                const response = await fetch(`${getBaseUrl()}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        model: currentModel || null,
                        use_llm_answer: useLlm,
                        rag_mode: currentRagMode,
                        rag_top_k: 5
                    })
                });

                const data = await response.json();

                // Sync model state with server response
                if (data.model_used) {
                    const modelNameEl = document.getElementById('modelName');
                    if (currentModel !== data.model_used) {
                        console.log(`Model sync: UI showed "${currentModel}", server used "${data.model_used}"`);
                        currentModel = data.model_used;
                        modelNameEl.textContent = data.model_used;
                    }
                }

                // Sync LLM mode state with server response
                if (data.use_llm_answer !== undefined && data.use_llm_answer !== useLlm) {
                    console.log(`LLM mode sync: UI showed "${useLlm}", server used "${data.use_llm_answer}"`);
                    document.getElementById('useLlmToggle').checked = data.use_llm_answer;
                    updateModeLabel();
                }

                // Store result for tab switching
                lastQueryResult = data;

                // Render with appropriate default tab
                if (data.success) {
                    const defaultTab = (useLlm && data.answer) ? 'llm' : 'table';
                    renderResult(data, defaultTab);
                } else {
                    renderResult(data);
                }
            } catch (error) {
                tabsDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>âŒ é€£ç·šéŒ¯èª¤</strong><br><br>
                        ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ (${config.host}:${config.port})<br>
                        è«‹æª¢æŸ¥ä¼ºæœå™¨æ˜¯å¦é‹è¡Œä¸­ã€‚<br><br>
                        éŒ¯èª¤è¨Šæ¯: ${escapeHtml(error.message)}
                    </div>
                `;
            } finally {
                sendBtn.disabled = false;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            // å»é™¤é–‹é ­å’Œçµå°¾çš„ç©ºç™½åŠæ›è¡Œ
            const trimmed = text.trim();
            const div = document.createElement('div');
            div.textContent = trimmed;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function escapeHtmlPreserveFormat(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateModeLabel() {
            const toggle = document.getElementById('useLlmToggle');
            const fastLabel = document.getElementById('modeFastLabel');
            const llmLabel = document.getElementById('modeLlmLabel');

            if (toggle.checked) {
                fastLabel.classList.remove('active');
                llmLabel.classList.add('active');
            } else {
                fastLabel.classList.add('active');
                llmLabel.classList.remove('active');
            }
        }

        // Store last query result for tab switching
        let lastQueryResult = null;

        function switchOutputTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Show corresponding content
            if (lastQueryResult) {
                renderResult(lastQueryResult, tab);
            }
        }

        function renderResult(data, activeTab = 'llm') {
            const resultDiv = document.getElementById('result');
            const tabsDiv = document.getElementById('resultTabs');
            const ragTab = document.getElementById('ragTab');

            if (!data.success) {
                tabsDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>âŒ æŸ¥è©¢å¤±æ•—</strong><br><br>
                        ${escapeHtml(data.error || 'æœªçŸ¥éŒ¯èª¤')}
                    </div>
                `;
                return;
            }

            tabsDiv.style.display = 'block';

            // Show/hide RAG tab based on whether we have RAG context
            const hasRagContext = data.rag_context && data.rag_context.length > 0;
            ragTab.style.display = hasRagContext ? 'inline-block' : 'none';

            // Update tab button states
            document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
            const tabIndex = activeTab === 'llm' ? 1 : activeTab === 'table' ? 2 : activeTab === 'rag' ? 3 : 4;
            const tabBtn = document.querySelector(`.output-tab:nth-child(${tabIndex})`);
            if (tabBtn) tabBtn.classList.add('active');

            const modelInfo = data.model_used ? `<span style="margin-left: 15px;">ğŸ¤– æ¨¡å‹: <strong>${escapeHtml(data.model_used)}</strong></span>` : '';
            const modeInfo = data.use_llm_answer !== undefined
                ? `<span style="margin-left: 15px;">${data.use_llm_answer ? 'ğŸ¤– LLMæ¨¡å¼' : 'âš¡ å¿«é€Ÿæ¨¡å¼'}</span>`
                : '';
            const ragModeLabels = { 'sql_only': 'ğŸ—„ï¸ åƒ…åº«å­˜', 'hybrid': 'ğŸ”€ æ··åˆ', 'rag_only': 'ğŸ“– åƒ…å‹éŒ„' };
            const ragModeInfo = data.rag_mode ? `<span class="rag-badge">${ragModeLabels[data.rag_mode] || data.rag_mode}</span>` : '';

            // è©³ç´°è¨ˆæ™‚è³‡è¨Š
            let timeInfo = '';
            if (data.timing) {
                const t = data.timing;
                const details = [];
                if (t.sql_generation) details.push(`SQLç”Ÿæˆ: ${t.sql_generation}ç§’`);
                if (t.query_execution) details.push(`æŸ¥è©¢åŸ·è¡Œ: ${t.query_execution}ç§’`);
                if (t.formatting) details.push(`æ ¼å¼åŒ–: ${t.formatting}ç§’`);
                if (t.llm_response) details.push(`LLMå›ç­”: ${t.llm_response}ç§’`);
                const tooltip = details.join(' | ');
                timeInfo = `<span style="margin-left: 15px; cursor: help;" title="${tooltip}">â±ï¸ ${t.total || data.elapsed_time}ç§’</span>`;
            } else if (data.elapsed_time !== undefined) {
                timeInfo = `<span style="margin-left: 15px;">â±ï¸ ${data.elapsed_time}ç§’</span>`;
            }

            // è¨ˆæ™‚è©³ç´°é¡¯ç¤º
            let timingDetail = '';
            if (data.timing) {
                const t = data.timing;
                const items = [];
                if (t.sql_generation) items.push(`<span class="timing-item">ğŸ¤– SQLç”Ÿæˆ <strong>${t.sql_generation}s</strong></span>`);
                if (t.query_execution) items.push(`<span class="timing-item">ğŸ” æŸ¥è©¢ <strong>${t.query_execution}s</strong></span>`);
                if (t.formatting) items.push(`<span class="timing-item">ğŸ“‹ æ ¼å¼åŒ– <strong>${t.formatting}s</strong></span>`);
                if (t.llm_response) items.push(`<span class="timing-item">ğŸ’¬ LLMå›ç­” <strong>${t.llm_response}s</strong></span>`);
                if (items.length > 0) {
                    timingDetail = `<div class="timing-breakdown">${items.join('')}<span class="timing-item timing-total">â±ï¸ ç¸½è¨ˆ <strong>${t.total || data.elapsed_time}s</strong></span></div>`;
                }
            }

            // Build SQL section (may be empty for rag_only mode)
            const sqlSection = data.sql ? `
                <div class="sql-box">
                    <div style="font-weight: bold; margin-bottom: 8px;">ğŸ“Š SQL æŸ¥è©¢:</div>
                    <div>${escapeHtml(data.sql)}</div>
                </div>
            ` : '';

            // Build RAG context count
            const ragContextCount = (data.rag_context && data.rag_context.length > 0)
                ? `<span style="margin-left: 10px;">ğŸ“š ${data.rag_context.length} å€‹å‹éŒ„ç‰‡æ®µ</span>`
                : '';

            let contentHtml = `
                ${sqlSection}
                <div class="result-count">å…± ${data.result_count || 0} ç­†çµæœ${ragContextCount}${modelInfo}${modeInfo} ${ragModeInfo}</div>
                ${timingDetail}
            `;

            if (activeTab === 'llm') {
                if (data.answer) {
                    contentHtml += `
                        <div class="answer-box">
                            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¤– LLM å›ç­”:</div>
                            <div>${escapeHtml(data.answer)}</div>
                        </div>
                    `;
                } else if (data.use_llm_answer === false) {
                    // ä½¿ç”¨è€…é¸æ“‡å¿«é€Ÿæ¨¡å¼
                    contentHtml += `
                        <div class="answer-box" style="background: #fef3c7; border-left-color: #f59e0b;">
                            <strong>âš¡ å¿«é€Ÿæ¨¡å¼</strong><br><br>
                            æ‚¨é¸æ“‡äº†å¿«é€Ÿæ¨¡å¼ï¼Œè«‹åˆ‡æ›åˆ°ã€Œè¡¨æ ¼æ ¼å¼ã€æŸ¥çœ‹çµæœï¼Œæˆ–é–‹å•Ÿ LLM æ¨¡å¼é‡æ–°æŸ¥è©¢ã€‚
                        </div>
                    `;
                } else if (data.result_count === 0) {
                    // LLM æ¨¡å¼ä½†ç„¡çµæœ
                    contentHtml += `
                        <div class="answer-box" style="background: #f0fdf4; border-left-color: #22c55e;">
                            <strong>ğŸ¤– LLM æ¨¡å¼</strong><br><br>
                            æŸ¥ç„¡è³‡æ–™ï¼Œç„¡æ³•ç”Ÿæˆ LLM å›ç­”ã€‚
                        </div>
                    `;
                } else {
                    // å…¶ä»–æƒ…æ³ï¼ˆLLM å¤±æ•—ç­‰ï¼‰
                    contentHtml += `
                        <div class="answer-box" style="background: #fef3c7; border-left-color: #f59e0b;">
                            <strong>âš ï¸ LLM å›ç­”ç”Ÿæˆå¤±æ•—</strong><br><br>
                            è«‹åˆ‡æ›åˆ°ã€Œè¡¨æ ¼æ ¼å¼ã€æŸ¥çœ‹çµæœã€‚
                        </div>
                    `;
                }
            } else if (activeTab === 'table') {
                if (data.answer_html) {
                    // ä½¿ç”¨ HTML è¡¨æ ¼ï¼ˆå®Œç¾å°é½Šï¼‰
                    contentHtml += `
                        <div class="html-table-container">${data.answer_html}</div>
                    `;
                } else if (data.answer_formatted) {
                    // é€€å›ç´”æ–‡å­—è¡¨æ ¼
                    contentHtml += `
                        <div class="table-box">${escapeHtmlPreserveFormat(data.answer_formatted)}</div>
                    `;
                } else {
                    contentHtml += `<div class="answer-box">ç„¡è¡¨æ ¼è³‡æ–™</div>`;
                }
            } else if (activeTab === 'rag') {
                // RAG context tab
                if (data.rag_context && data.rag_context.length > 0) {
                    let ragHtml = '<div class="rag-context-box"><div class="rag-context-header">ğŸ“š å‹éŒ„åƒè€ƒè³‡æ–™</div>';
                    data.rag_context.forEach((ctx, index) => {
                        const source = ctx.source || 'æœªçŸ¥ä¾†æº';
                        const page = ctx.page ? `ç¬¬ ${ctx.page} é ` : '';
                        const score = ctx.score ? `ç›¸é—œåº¦: ${(ctx.score * 100).toFixed(1)}%` : '';
                        const content = ctx.content || '';
                        ragHtml += `
                            <div class="rag-source-item">
                                <div class="rag-source-meta">
                                    <span>ğŸ“„ ${escapeHtml(source)}</span>
                                    ${page ? `<span>${page}</span>` : ''}
                                    ${score ? `<span>${score}</span>` : ''}
                                </div>
                                <div class="rag-source-content">${escapeHtml(content)}</div>
                            </div>
                        `;
                    });
                    ragHtml += '</div>';
                    contentHtml += ragHtml;
                } else {
                    contentHtml += `<div class="answer-box">ç„¡å‹éŒ„åƒè€ƒè³‡æ–™</div>`;
                }
            } else if (activeTab === 'raw') {
                if (data.results && data.results.length > 0) {
                    contentHtml += `
                        <div class="sql-box" style="max-height: 400px; overflow-y: auto;">
                            <strong>ğŸ“„ åŸå§‹ JSON:</strong><br><br>
                            ${escapeHtmlPreserveFormat(JSON.stringify(data.results, null, 2))}
                        </div>
                    `;
                } else {
                    contentHtml += `<div class="answer-box">ç„¡åŸå§‹è³‡æ–™</div>`;
                }
            }

            resultDiv.innerHTML = contentHtml;
        }

        // Model selector functions
        let currentModel = '';
        let availableModels = [];

        function toggleModelDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('modelDropdown');
            const isVisible = dropdown.classList.contains('show');

            if (!isVisible) {
                dropdown.classList.add('show');
                loadModels();
            } else {
                dropdown.classList.remove('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            const dropdown = document.getElementById('modelDropdown');
            const selector = document.querySelector('.model-selector');
            if (!selector.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // æ¨è–¦æ¨¡å‹åˆ—è¡¨ï¼ˆåªé¡¯ç¤ºé€™äº›æ¨¡å‹ï¼‰
        const RECOMMENDED_MODELS = ['80b', '30b', '8b'];

        function isRecommendedModel(modelName) {
            const lowerName = modelName.toLowerCase();
            return RECOMMENDED_MODELS.some(size => lowerName.includes(size));
        }

        async function loadModels() {
            const modelList = document.getElementById('modelList');
            const modelNameEl = document.getElementById('modelName');
            modelList.innerHTML = '<div class="model-loading">è¼‰å…¥ä¸­...</div>';

            try {
                const response = await fetch(`${getBaseUrl()}/api/models`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();

                currentModel = data.current;
                // åªä¿ç•™æ¨è–¦çš„æ¨¡å‹ï¼ˆ80b, 30b, 8bï¼‰
                availableModels = data.models.filter(isRecommendedModel);

                // ç¢ºä¿ç•¶å‰æ¨¡å‹åœ¨åˆ—è¡¨ä¸­ï¼ˆå³ä½¿ä¸åœ¨æ¨è–¦åˆ—è¡¨ï¼‰
                if (currentModel && !availableModels.includes(currentModel)) {
                    availableModels.unshift(currentModel);
                }

                // Also sync status bar display
                modelNameEl.textContent = currentModel;

                renderModelList();
            } catch (error) {
                modelList.innerHTML = `<div class="model-loading" style="color: #ef4444;">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        function getModelLabel(modelName) {
            const lowerName = modelName.toLowerCase();
            if (lowerName.includes('80b')) return 'â­ æœ€æº–ç¢º';
            if (lowerName.includes('30b')) return 'âš¡ å¹³è¡¡';
            if (lowerName.includes('8b')) return 'ğŸš€ æ¥µé€Ÿ';
            return '';
        }

        function renderModelList() {
            const modelList = document.getElementById('modelList');

            if (availableModels.length === 0) {
                modelList.innerHTML = '<div class="model-loading">æ²’æœ‰å¯ç”¨çš„æ¨¡å‹</div>';
                return;
            }

            modelList.innerHTML = availableModels.map(model => {
                const isActive = model === currentModel;
                const displayName = model.length > 30 ? model.substring(0, 27) + '...' : model;
                const label = getModelLabel(model);
                return `
                    <div class="model-item ${isActive ? 'active' : ''}"
                         onclick="selectModel('${model}')"
                         title="${model}">
                        <span>${displayName}</span>
                        ${label ? `<span class="model-label">${label}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function selectModel(modelName) {
            if (modelName === currentModel) {
                document.getElementById('modelDropdown').classList.remove('show');
                return;
            }

            // Show loading state
            const items = document.querySelectorAll('.model-item');
            items.forEach(item => item.classList.add('loading'));
            document.getElementById('modelDropdown').classList.remove('show');

            const modelNameEl = document.getElementById('modelName');
            modelNameEl.textContent = 'åˆ‡æ›ä¸­...';

            try {
                const response = await fetch(`${getBaseUrl()}/api/models/select`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ model: modelName })
                });

                const data = await response.json();

                if (data.success) {
                    // Update local state immediately from server response
                    currentModel = data.current;
                    modelNameEl.textContent = data.current;

                    // Also verify with health check
                    await checkHealth();

                    // Show success message
                    alert(`æ¨¡å‹å·²åˆ‡æ›ç‚º: ${data.current}`);
                } else {
                    alert(`åˆ‡æ›å¤±æ•—: ${data.detail || 'æœªçŸ¥éŒ¯èª¤'}`);
                    await checkHealth();
                }
            } catch (error) {
                alert(`åˆ‡æ›å¤±æ•—: ${error.message}`);
                await checkHealth();
            } finally {
                items.forEach(item => item.classList.remove('loading'));
            }
        }
    </script>
</body>
</html>
